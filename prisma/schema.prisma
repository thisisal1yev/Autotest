generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  GUEST
  STUDENT
  ADMIN
  SUPERADMIN
}

enum SubscriptionPlan {
  FREE
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  EXPIRED
  CANCELLED
  SUSPENDED
}

model User {
  id              Int            @id @default(autoincrement())
  email           String         @unique
  login           String         @unique
  password        String
  fullName        String
  role            Role           @default(GUEST)
  drivingSchoolId Int?
  drivingSchool   DrivingSchool? @relation(fields: [drivingSchoolId], references: [id])
  isActive        Boolean        @default(true)
  testResults     TestResult[]
  groups          Group[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([drivingSchoolId])
}

model DrivingSchool {
  id           Int            @id @default(autoincrement())
  name         String
  email        String?
  phone        String?
  address      String?
  users        User[]
  tests        Test[]
  tutorials    Tutorial[]
  subscriptions Subscription[]
  groups       Group[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Test {
  id              Int           @id @default(autoincrement())
  title           String
  description     String?
  questions       Question[] // Array of question objects
  timeLimit       Int? // Time limit in minutes
  passingScore    Int?          @default(0) // Passing score percentage
  drivingSchoolId Int
  drivingSchool   DrivingSchool @relation(fields: [drivingSchoolId], references: [id])
  testResults     TestResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([drivingSchoolId])
}

model Question {
  id      Int      @id @default(autoincrement())
  imgPath String
  title   String
  comment String

  options Option[]
  answers Answers[] // Добавить эту строку

  testId Int
  test   Test @relation(fields: [testId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([testId])
}

model Option {
  id           Int       @id @default(autoincrement())
  answerOption String
  isCorrect    Boolean
  
  answers      Answers[] // Добавить эту строку

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questionId Int?
  question   Question? @relation(fields: [questionId], references: [id])

  @@index([questionId])
}

model Tutorial {
  id              Int           @id @default(autoincrement())
  title           String
  description     String?
  videoUrl        String
  thumbnailUrl    String?
  duration        Int? // Duration in seconds
  order           Int           @default(0)
  drivingSchoolId Int
  drivingSchool   DrivingSchool @relation(fields: [drivingSchoolId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([drivingSchoolId])
}

model Answers {
  id           Int        @id @default(autoincrement())
  
  // Связь с результатом теста
  testResultId Int
  testResult   TestResult @relation(fields: [testResultId], references: [id], onDelete: Cascade)
  
  // Связь с вопросом
  questionId   Int
  question     Question   @relation(fields: [questionId], references: [id])
  
  // Выбранный вариант ответа (может быть null если не ответил)
  optionId     Int?
  option       Option?    @relation(fields: [optionId], references: [id])
  
  // Правильность ответа
  isCorrect    Boolean?
  
  // Порядок ответа (для отслеживания последовательности)
  order        Int        @default(0)
  
  // Время, потраченное на этот вопрос (в секундах)
  timeSpent    Int?
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([testResultId])
  @@index([questionId])
  @@index([optionId])
  
  // Уникальность: один ответ на вопрос в рамках одного результата теста
  @@unique([testResultId, questionId])
}

model TestResult {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id])
  testId      Int
  test        Test      @relation(fields: [testId], references: [id])
  score       Int       // Score percentage
  answers     Answers[] // User's answers
  passed      Boolean
  completedAt DateTime  @default(now())
  
  // Дополнительная информация
  timeSpent   Int?      // Общее время прохождения в секундах
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([testId])
}

model Subscription {
  id            Int                @id @default(autoincrement())
  drivingSchoolId Int
  drivingSchool   DrivingSchool    @relation(fields: [drivingSchoolId], references: [id])
  plan          SubscriptionPlan
  status        SubscriptionStatus
  startDate     DateTime
  endDate       DateTime?
  trialEndDate  DateTime?
  price         Decimal            @db.Decimal(10, 2)
  currency      String             @default("USD")
  autoRenewal   Boolean            @default(true)
  cancelledAt   DateTime?
  paymentMethod String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([drivingSchoolId])
  @@index([status])
}

model Group {
  id              Int            @id @default(autoincrement())
  name            String
  description     String?
  drivingSchoolId Int
  drivingSchool   DrivingSchool @relation(fields: [drivingSchoolId], references: [id])
  students        User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([drivingSchoolId])
}
